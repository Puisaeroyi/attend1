# Attendance Cleaning Rules for 4 CCTV Operators
# Version 9.0 - Complete ruleset with shift-instance grouping and intelligent break detection
# Key Features:
#   - Shift-instance grouping (no split night shifts)
#   - Gap-based break detection with midpoint fallback
#   - Burst detection for multiple rapid swipes
#   - Strict time window enforcement

system_overview: |
  Process biometric swipe logs for 4 CCTV operators in 3-shift rotation.
  Complete flow: Check-in → Work → Break Out → Break Period → Break In → Resume Work → Check-out
  One shift = One complete record (even if crossing midnight)

dataset_requirements:
  input_logs:
    status_filter: "Success only"
    required_fields:
      - Username
      - Date
      - Time/Timestamp
      - Authentication

operators:
  valid_users:
    - Silver_Bui
    - Capone
    - Minh
    - Trieu
  
  preprocessing:
    - trim_whitespace
    - lowercase
    - canonical_name_mapping
  
  user_mapping:
    Silver_Bui:
      output_name: "Bui Duc Toan"
      output_id: "TPL0001"
    Capone:
      output_name: "Pham Tan Phat"
      output_id: "TPL0002"
    Minh:
      output_name: "Mac Le Duc Minh"
      output_id: "TPL0003"
    Trieu:
      output_name: "Nguyen Hoang Trieu"
      output_id: "TPL0004"
  
  display_requirement: "Show all users in output"

grouping_logic:
  primary_grouping: "shift_instance"
  
  shift_instance_definition:
    - "A shift instance begins with a valid First In swipe"
    - "Includes all activities until shift window ends"
    - "Night shifts maintain single record despite crossing midnight"
    - "Date column shows shift START date, not individual swipe dates"
  
  shift_boundaries:
    A_shift:  # Morning: 06:00-14:00
      shift_date: "Calendar date of First In"
      activity_window: "05:30 on shift_date THROUGH 14:35 on shift_date"
      
    B_shift:  # Afternoon: 14:00-22:00
      shift_date: "Calendar date of First In"
      activity_window: "13:30 on shift_date THROUGH 22:35 on shift_date"
      
    C_shift:  # Night: 22:00-06:00 (CROSSES MIDNIGHT)
      shift_date: "Calendar date of First In"
      activity_window: "21:30 on shift_date THROUGH 06:35 on (shift_date + 1)"
      special_handling: "All next-day swipes before 06:35 belong to previous day's shift"

burst_detection:
  definition: "Multiple swipes within <= 2 minutes grouped as single burst"
  
  processing:
    order: "MUST apply before all other logic"
    representation:
      burst_start: "Earliest swipe in burst"
      burst_end: "Latest swipe in burst"
    
  example:
    input: "09:55, 09:56, 09:57, 09:58, 09:59, 10:01"
    output: "Single burst from 09:55 to 10:01"

shift_structure:
  shifts:
    A:
      name: "Morning"
      window: "06:00-14:00"
      check_in_search_range: "05:30-06:35"
      check_out_search_range: "13:30-14:35"
      grace_period_minutes: 5
      
    B:
      name: "Afternoon"  
      window: "14:00-22:00"
      check_in_search_range: "13:30-14:35"
      check_out_search_range: "21:30-22:35"
      grace_period_minutes: 5
      
    C:
      name: "Night"
      window: "22:00-06:00"
      check_in_search_range: "21:30-22:35"
      check_out_search_range: "05:30-06:35"  # Next calendar day
      grace_period_minutes: 5
  
  detection_rules:
    shift_identification: "Based on First In location within search ranges"
    late_marking: "First In > (shift_start + grace_period)"
    strict_exclusion: "Ignore all swipes outside defined ranges"

break_detection:
  parameters:
    A_shift:
      window: "10:00-10:30"
      search_range: "09:50-10:35"
      midpoint_checkpoint: "10:15"
      minimum_break_gap_minutes: 5
      
    B_shift:
      window: "18:00-18:30"
      search_range: "17:50-18:35"
      midpoint_checkpoint: "18:15"
      minimum_break_gap_minutes: 5
      
    C_shift:
      window: "02:00-02:45"
      search_range: "01:50-02:45"  # On shift_date + 1 for night shift
      midpoint_checkpoint: "02:22:30"
      minimum_break_gap_minutes: 5
  
  detection_algorithm:
    priority_1_gap_detection:
      description: "Primary method - detect actual break via time gap"
      condition: "Gap >= minimum_break_gap between any two swipes/bursts"
      action:
        break_out: "Swipe/burst immediately before gap"
        break_in: "Swipe/burst immediately after gap"
      
    priority_2_midpoint_logic:
      description: "Fallback method when no clear gap exists"
      
      swipes_span_midpoint:
        condition: "Some swipes before AND after midpoint"
        break_out: "Latest before/at midpoint"
        break_in: "Earliest after midpoint"
      
      all_swipes_before_midpoint:
        condition: "All swipes before midpoint with gap >= minimum"
        break_out: "First swipe before gap"
        break_in: "First swipe after gap"
        
        condition_no_gap: "All swipes before midpoint without qualifying gap"
        break_out: "Latest swipe"
        break_in: "Leave blank"
      
      all_swipes_after_midpoint:
        condition: "All swipes after midpoint with gap >= minimum"
        break_out: "First swipe before gap"
        break_in: "First swipe after gap"
        
        condition_no_gap: "All swipes after midpoint without qualifying gap"
        break_out: "Leave blank"
        break_in: "Latest swipe"
    
    single_swipe_logic:
      before_midpoint:
        break_out: "Use swipe time"
        break_in: "Leave blank"
      at_or_after_midpoint:
        break_out: "Leave blank"
        break_in: "Use swipe time"
    
    no_swipes_in_range:
      break_out: "Leave blank"
      break_in: "Leave blank"

output_columns:
  - Date        # Shift start date
  - ID          # Employee ID
  - Name        # Full name
  - Shift       # A/B/C or Morning/Afternoon/Night
  - First In    # Check-in time
  - Break Out   # Break start
  - Break In    # Break end
  - Last Out    # Check-out time

processing_sequence:
  step_1_collect_swipes:
    - "Gather all swipes for each employee"
    - "Sort chronologically across all dates"
  
  step_2_identify_shifts:
    - "Find swipes in check_in_search_ranges"
    - "Each marks a new shift instance"
    - "Assign shift date from First In"
  
  step_3_group_shift_activities:
    night_shift_C:
      - "First In between 21:30-22:35 on Day N"
      - "Include all swipes until 06:35 on Day N+1"
      - "Output with Date = Day N"
    
    day_shifts_A_B:
      - "Include all swipes within same-day windows"
      - "Output with Date = shift date"
  
  step_4_process_each_shift:
    a_burst_grouping:
      - "Combine swipes within 2-minute windows"
    
    b_extract_first_in:
      - "Earliest swipe/burst_start in check_in_search_range"
    
    c_extract_last_out:
      - "Latest swipe/burst_end in check_out_search_range"
    
    d_detect_breaks:
      - "Apply gap-detection algorithm first"
      - "Fall back to midpoint logic if needed"
      - "Handle single swipes with checkpoint"
    
    e_output_single_row:
      - "One complete row per shift instance"

validation_rules:
  - "Timestamps outside search ranges: excluded"
  - "Orphan swipes without shift start: ignored"
  - "Bursts treated as atomic units"
  - "Night shift swipes on next day: attributed to previous day's shift"
  - "Empty cells for missing timestamps: allowed"

example_scenarios:
  scenario_1_normal_day_shift:
    input_swipes:
      - "2025-11-04 05:55"
      - "2025-11-04 09:55"
      - "2025-11-04 10:25"
      - "2025-11-04 14:05"
    output:
      Date: "2025-11-04"
      Shift: "A"
      First_In: "05:55"
      Break_Out: "09:55"
      Break_In: "10:25"
      Last_Out: "14:05"
  
  scenario_2_burst_with_breaks:
    input_swipes:
      - "2025-11-04 05:55"
      - "2025-11-04 09:55, 09:56, 09:57, 09:58, 09:59, 10:01"  # Burst
      - "2025-11-04 10:25"
      - "2025-11-04 14:05"
    output:
      Date: "2025-11-04"
      Shift: "A"
      First_In: "05:55"
      Break_Out: "10:01"  # End of burst
      Break_In: "10:25"
      Last_Out: "14:05"
  
  scenario_3_late_break_after_midpoint:
    input_swipes:
      - "2025-11-04 06:00"
      - "2025-11-04 10:20"  # After 10:15 midpoint
      - "2025-11-04 10:29"  # After 10:15 midpoint
      - "2025-11-04 14:00"
    analysis: "9-minute gap detected between 10:20 and 10:29"
    output:
      Date: "2025-11-04"
      Shift: "A"
      First_In: "06:00"
      Break_Out: "10:20"  # Gap-based detection
      Break_In: "10:29"   # Gap-based detection
      Last_Out: "14:00"
  
  scenario_4_night_shift_crossing_midnight:
    input_swipes:
      - "2025-11-03 21:55:28"
      - "2025-11-04 02:00:35"
      - "2025-11-04 02:44:51"
      - "2025-11-04 06:03:14"
    output:
      Date: "2025-11-03"  # Shift START date
      ID: "TPL0002"
      Name: "Pham Tan Phat"
      Shift: "Night"
      First_In: "21:55:28"
      Break_Out: "02:00:35"  # Next calendar day but same shift
      Break_In: "02:44:51"   # Next calendar day but same shift
      Last_Out: "06:03:14"   # Next calendar day but same shift
  
  scenario_5_single_swipe_before_midpoint:
    input_swipes:
      - "2025-11-04 06:00"
      - "2025-11-04 10:08"  # Before 10:15
      - "2025-11-04 14:00"
    output:
      Date: "2025-11-04"
      Shift: "A"
      First_In: "06:00"
      Break_Out: "10:08"
      Break_In: ""  # Blank
      Last_Out: "14:00"
  
  scenario_6_no_break_taken:
    input_swipes:
      - "2025-11-04 06:00"
      - "2025-11-04 14:00"
    output:
      Date: "2025-11-04"
      Shift: "A"
      First_In: "06:00"
      Break_Out: ""  # Blank
      Break_In: ""   # Blank
      Last_Out: "14:00"

explicitly_not_implemented:
  - "Break duration validation"
  - "Minimum break requirements"
  - "NO_BTO/NO_BTI flags"
  - "Workday conversion (keeping 06:00 as cutoff)"
  - "Deduction calculations"
  - "Cumulative break tracking"
  - "Office staff handling"
  - "Multiple breaks per shift"
  - "Overtime calculations"

system_goals: |
  1. Accurately reflect real attendance patterns from biometric logs
  2. Handle edge cases intelligently without manual intervention
  3. Maintain shift integrity (one shift = one complete record)
  4. Provide clear, auditable output for payroll/compliance
  5. Eliminate data fragmentation from midnight crossings